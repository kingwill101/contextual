# Migration to v2

Contextual v2 focuses on ergonomics, typed configuration, and type-based APIs. This guide highlights the key changes and how to migrate.

## Key changes

- Typed configuration via `TypedLogConfig` and channel config classes replaces map-based `LogConfig` and string keys. The runtime channel wrapper is `Channel<T extends LogDriver>`. 
- Type-based selection via `logger.forDriver<T>()` and name-based `logger['name']` targeting.
- Centralized middleware pipeline order is `global -> channel -> driver-type`.
- Batching ergonomics via `logger.batched()`/`logger.unbatched()` or `TypedLogConfig.batching`.

## Before → After

### Configuration

Before (v1):
```dart
final config = LogConfig.fromJson({
  'channels': {
    'console': {'driver': 'console'},
    'file': {'driver': 'daily', 'config': {'path': 'logs/app'}},
  },
});
final logger = Logger(config: config);
```

After (v2):
```dart
final config = TypedLogConfig(
  environment: 'production',
  channels: const [
    ConsoleChannel(ConsoleOptions(), name: 'console'),
    DailyFileChannel(DailyFileOptions(path: 'logs/app'), name: 'file'),
  ],
);
final logger = await Logger.create(typedConfig: config);
```

### Selection

Before:
```dart
logger.forDriver<ConsoleLogDriver>().info('...');
```
After:
```dart
logger.forDriver<ConsoleLogDriver>().info('...');
logger['console'].info('...'); // name-based
```


### Driver middlewares

Before:
```dart
logger.addDriverMiddleware<ConsoleLogDriver>(MyMiddleware());
```
After:
```dart
logger.addDriverMiddleware<ConsoleLogDriver>(MyMiddleware());
// If you absolutely need name-based registration:

```

Middleware signature changed from:
```dart
FutureOr<DriverMiddlewareResult> handle(String driverName, LogEntry entry)
```
To:
```dart
FutureOr<DriverMiddlewareResult> handle(LogEntry entry)
```

### Middleware

Before: drivers/channels could each apply middleware.

After: single pipeline in Logger, order: `global -> channel -> driver-type`.

### File driver factory

Before:
```dart
DailyFileLogDriver.fromConfig({'path': 'logs/app'})
```
After:
```dart
DailyFileLogDriver.fromOptions(const DailyFileOptions(path: 'logs/app'))
```

## Tips

- Prefer typed configuration for safety and IDE help.
- Use batching for high throughput. Most apps won’t need `shutdown()` except when using file-based drivers.
- Update examples and docs to remove `LogConfig` and map-based config.

## Breaking changes

- Removed `LogConfig`, `ChannelConfig`, and `fromConfig` constructors.
- Removed legacy string driver factory.
- Environment handling is typed via `TypedLogConfig.environment`.
